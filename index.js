"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const crlf_normalize_1 = require("crlf-normalize");
const novel_segment_1 = require("novel-segment");
exports.stringify = novel_segment_1.stringify;
const bluebird = require("bluebird");
const fs = require("fs-extra");
const lib_1 = require("novel-segment/lib");
const cache_1 = require("./lib/cache");
const util_1 = require("./lib/util");
exports.enableDebug = util_1.enableDebug;
const PACKAGE_JSON = require("./package.json");
const util_2 = require("novel-segment/lib/util");
const iconv = require("iconv-jschardet");
let CACHED_SEGMENT;
let CACHED_CACACHE;
const DB_KEY = 'cache.db';
const DB_KEY_INFO = 'cache.info';
const DB_TTL = 3600 * 1000;
function textSegment(text, options) {
    return getSegment(options)
        .then(function (segment) {
        return segment.doSegment(text);
    })
        .tap(function (data) {
        return util_2.debug_token(data);
    });
}
exports.textSegment = textSegment;
function fileSegment(file, options) {
    return bluebird.resolve(readFile(file))
        .then(function (buf) {
        return textSegment(buf.toString(), options);
    });
}
exports.fileSegment = fileSegment;
function processText(text, options) {
    if (!text.length || !text.replace(/\s+/g, '').length) {
        return bluebird.resolve('');
    }
    return textSegment(text, options)
        .then(function (data) {
        let text = novel_segment_1.stringify(data);
        if (options) {
            if (options.crlf) {
                if (typeof options.crlf === 'string') {
                    text = crlf_normalize_1.default(text, options.crlf);
                }
                else {
                    text = crlf_normalize_1.default(text);
                }
            }
        }
        util_1.freeGC();
        return text;
    });
}
exports.processText = processText;
function processFile(file, options) {
    return bluebird.resolve(readFile(file, options))
        .then(function (buf) {
        return processText(buf.toString(), options);
    });
}
exports.processFile = processFile;
class SegmentCliError extends Error {
}
exports.SegmentCliError = SegmentCliError;
function readFile(file, options) {
    return new bluebird((resolve, reject) => {
        if (!fs.existsSync(file)) {
            let e = new SegmentCliError(`ENOENT: no such file or directory, open '${file}'`);
            reject(e);
        }
        else {
            fs.readFile(file).then(resolve);
        }
    })
        .tap(function (buf) {
        if (options && options.disableWarn) {
            return;
        }
        if (!buf.length) {
            util_1.console.warn(`此檔案無內容`, file);
        }
        else {
            let chk = iconv.detect(buf);
            if (chk.encoding != 'UTF-8' && chk.encoding != 'ascii') {
                util_1.console.warn('此檔案可能不是 UTF8 請檢查編碼或利用 MadEdit 等工具轉換', chk, file);
            }
        }
    });
}
exports.readFile = readFile;
function fixOptions(options) {
    options = options || {};
    if (typeof options.ttl !== 'number' || options.ttl < 1) {
        delete options.ttl;
    }
    return options;
}
exports.fixOptions = fixOptions;
function getCacache(options) {
    return new bluebird(function (resolve, reject) {
        if (!CACHED_CACACHE) {
            if (options && options.useGlobalCache) {
                CACHED_CACACHE = new cache_1.Cacache({
                    name: PACKAGE_JSON.name,
                    useGlobalCache: options.useGlobalCache,
                });
            }
            else {
                CACHED_CACACHE = new cache_1.Cacache(PACKAGE_JSON.name);
            }
        }
        resolve(CACHED_CACACHE);
    });
}
exports.getCacache = getCacache;
function resetSegment() {
    CACHED_SEGMENT = void 0;
}
exports.resetSegment = resetSegment;
function getSegment(options) {
    options = fixOptions(options);
    let { disableCache } = options;
    return bluebird
        .resolve()
        .then(async function () {
        await getCacache(options);
        if (!CACHED_SEGMENT) {
            CACHED_SEGMENT = new novel_segment_1.default({
                autoCjk: true,
                optionsDoSegment: {
                    convertSynonym: true,
                },
                all_mod: true,
            });
            let _options = {
                /**
                 * 開啟 all_mod 才會在自動載入時包含 ZhtSynonymOptimizer
                 */
                all_mod: true,
            };
            let _info = await loadCacheInfo(options);
            let version = {
                [PACKAGE_JSON.name]: PACKAGE_JSON.version,
                ...novel_segment_1.default.versions,
                [PACKAGE_JSON.name]: PACKAGE_JSON.version,
            };
            let cache_db = await loadCacheDb(options);
            let _do_init;
            if (disableCache) {
                _do_init = true;
            }
            if (typeof _do_init == 'undefined'
                && _info
                && _info.current
                && _info.current[PACKAGE_JSON.name]) {
                Object.keys(version)
                    .some(key => {
                    let bool = _info[key] != version[key];
                    if (bool) {
                        util_1.debugConsole.debug(`本次執行的版本與上次緩存的版本不同`);
                        _do_init = true;
                    }
                    return bool;
                });
            }
            if (typeof _do_init == 'undefined' && cache_db) {
                if (cache_db.DICT) {
                    util_1.debugConsole.debug(`載入緩存字典`);
                    lib_1.useDefault(CACHED_SEGMENT, {
                        ...options,
                        nodict: true,
                        all_mod: true,
                    });
                    CACHED_SEGMENT.DICT = cache_db.DICT;
                    CACHED_SEGMENT.inited = true;
                    _do_init = false;
                    //console.dir(CACHED_SEGMENT.modules);
                }
            }
            if (typeof _do_init == 'undefined' || _do_init) {
                util_1.debugConsole.debug(`重新載入分析字典`);
                CACHED_SEGMENT.autoInit(_options);
                _do_init = true;
            }
            else {
                CACHED_SEGMENT
                    .loadSynonymDict('synonym')
                    .loadSynonymDict('zht.synonym', false)
                    .loadBlacklistDict('blacklist')
                    .loadBlacklistOptimizerDict('blacklist.name');
                CACHED_SEGMENT.doBlacklist();
            }
            let db_dict = CACHED_SEGMENT.getDictDatabase('TABLE', true);
            db_dict.TABLE = CACHED_SEGMENT.DICT['TABLE'];
            db_dict.TABLE2 = CACHED_SEGMENT.DICT['TABLE2'];
            db_dict.options.autoCjk = true;
            //CACHED_SEGMENT.loadSynonymDict('synonym', true);
            let size_db_dict = db_dict.size();
            CACHED_SEGMENT.loadSynonymDict('synonym', true);
            let size_segment = Object.keys(CACHED_SEGMENT.getDict('SYNONYM')).length;
            util_1.debugConsole.debug('主字典總數', size_db_dict);
            util_1.debugConsole.debug('Synonym', size_segment);
            _info.last = Object.assign({}, _info.current);
            _info.current = {
                size_db_dict,
                size_segment,
                size_db_dict_diff: size_db_dict - (_info.last.size_db_dict || 0),
                size_segment_diff: size_segment - (_info.last.size_segment || 0),
                version,
            };
            util_1.debugConsole.debug(_info);
            if (!disableCache
                && (_do_init || !cache_db || !cache_db.DICT)) {
                await CACHED_CACACHE.writeJSON(DB_KEY, {
                    ..._info,
                    DICT: CACHED_SEGMENT.DICT,
                });
                util_1.debugConsole.debug(`緩存字典於 ${DB_KEY}`, CACHED_CACACHE.cachePath);
            }
            util_1.freeGC();
        }
        return CACHED_SEGMENT;
    });
}
exports.getSegment = getSegment;
function loadCacheInfo(options) {
    return bluebird
        .resolve()
        .then(async function () {
        await getCacache(options);
        let has_cache_db = await CACHED_CACACHE.hasData(DB_KEY_INFO);
        let data;
        if (has_cache_db) {
            data = await CACHED_CACACHE
                .readJSON(DB_KEY_INFO)
                .then(function (ret) {
                return ret.json;
            });
        }
        data = data || {};
        data.last = data.last || {};
        data.current = data.current || {};
        data.last.version = data.last.version || {};
        data.current.version = data.current.version || {};
        return data;
    });
}
exports.loadCacheInfo = loadCacheInfo;
function loadCacheDb(options) {
    options = fixOptions(options);
    let { disableCache } = options;
    if (disableCache) {
        return bluebird
            .resolve(null);
    }
    return bluebird
        .resolve()
        .then(async function () {
        await getCacache(options);
        let has_cache_db = await CACHED_CACACHE.hasData(DB_KEY, {
            ttl: options.ttl > 0 ? options.ttl : DB_TTL,
        });
        if (has_cache_db) {
            util_1.debugConsole.debug(`發現緩存 ${DB_KEY}`, has_cache_db.path);
            return CACHED_CACACHE
                .readJSON(DB_KEY)
                .then(function (ret) {
                return ret.json;
            });
        }
        return null;
    });
}
exports.loadCacheDb = loadCacheDb;
function removeCache(options) {
    return getCacache(fixOptions(options))
        .tap(async function (cache) {
        await cache.clearMemoized();
        await cache.removeAll();
    });
}
exports.removeCache = removeCache;
function resetCache() {
    CACHED_CACACHE = void 0;
}
exports.resetCache = resetCache;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLG1EQUFrQztBQUNsQyxpREFBbUQ7QUFpQjdCLG9CQWpCSix5QkFBUyxDQWlCSTtBQWhCL0IscUNBQXNDO0FBQ3RDLCtCQUErQjtBQUMvQiwyQ0FBK0M7QUFDL0MsdUNBQXNDO0FBQ3RDLHFDQUF5RjtBQVloRixzQkFad0Msa0JBQVcsQ0FZeEM7QUFYcEIsK0NBQWdEO0FBQ2hELGlEQUFvRDtBQUNwRCx5Q0FBeUM7QUFFekMsSUFBSSxjQUEyRCxDQUFDO0FBQ2hFLElBQUksY0FBdUIsQ0FBQztBQUU1QixNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUM7QUFDMUIsTUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDO0FBQ2pDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFtQjNCLFNBQWdCLFdBQVcsQ0FBQyxJQUFZLEVBQUUsT0FBNEI7SUFFckUsT0FBTyxVQUFVLENBQUMsT0FBTyxDQUFDO1NBQ3hCLElBQUksQ0FBQyxVQUFVLE9BQU87UUFFdEIsT0FBTyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUMsQ0FBQztTQUNELEdBQUcsQ0FBQyxVQUFVLElBQUk7UUFFbEIsT0FBTyxrQkFBVyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3pCLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQVpELGtDQVlDO0FBRUQsU0FBZ0IsV0FBVyxDQUFDLElBQVksRUFBRSxPQUE0QjtJQUVyRSxPQUFPLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JDLElBQUksQ0FBQyxVQUFVLEdBQUc7UUFFbEIsT0FBTyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQVJE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ZSA9IHJlcXVpcmUoJ2NhY2FjaGUnKTtcbmltcG9ydCBjcmxmIGZyb20gJ2NybGYtbm9ybWFsaXplJztcbmltcG9ydCBTZWdtZW50LCB7IHN0cmluZ2lmeSB9IGZyb20gJ25vdmVsLXNlZ21lbnQnO1xuaW1wb3J0IGJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IHVzZURlZmF1bHQgfSBmcm9tICdub3ZlbC1zZWdtZW50L2xpYic7XG5pbXBvcnQgeyBDYWNhY2hlIH0gZnJvbSAnLi9saWIvY2FjaGUnO1xuaW1wb3J0IHsgY29uc29sZSwgZGVidWdDb25zb2xlLCBnZXRDYWNoZURpclBhdGgsIGVuYWJsZURlYnVnLCBmcmVlR0MgfSBmcm9tICcuL2xpYi91dGlsJztcbmltcG9ydCBQQUNLQUdFX0pTT04gPSByZXF1aXJlKCcuL3BhY2thZ2UuanNvbicpO1xuaW1wb3J0IHsgZGVidWdfdG9rZW4gfSBmcm9tICdub3ZlbC1zZWdtZW50L2xpYi91dGlsJ1xuaW1wb3J0ICogYXMgaWNvbnYgZnJvbSAnaWNvbnYtanNjaGFyZGV0JztcblxubGV0IENBQ0hFRF9TRUdNRU5UOiBpbXBvcnQoXCJub3ZlbC1zZWdtZW50L2xpYi9TZWdtZW50XCIpLlNlZ21lbnQ7XG5sZXQgQ0FDSEVEX0NBQ0FDSEU6IENhY2FjaGU7XG5cbmNvbnN0IERCX0tFWSA9ICdjYWNoZS5kYic7XG5jb25zdCBEQl9LRVlfSU5GTyA9ICdjYWNoZS5pbmZvJztcbmNvbnN0IERCX1RUTCA9IDM2MDAgKiAxMDAwO1xuXG5leHBvcnQgeyBlbmFibGVEZWJ1Zywgc3RyaW5naWZ5IH1cblxuZXhwb3J0IGludGVyZmFjZSBJU2VnbWVudENMSU9wdGlvbnNcbntcblx0LyoqXG5cdCAqIOagvOW8j+WMluWIhuihjOespuiZn1xuXHQgKi9cblx0Y3JsZj86IHN0cmluZyB8IGJvb2xlYW4sXG5cblx0dXNlR2xvYmFsQ2FjaGU/OiBib29sZWFuLFxuXHRkaXNhYmxlQ2FjaGU/OiBib29sZWFuLFxuXG5cdGRpc2FibGVXYXJuPzogYm9vbGVhbixcblxuXHR0dGw/OiBudW1iZXIsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0ZXh0U2VnbWVudCh0ZXh0OiBzdHJpbmcsIG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpXG57XG5cdHJldHVybiBnZXRTZWdtZW50KG9wdGlvbnMpXG5cdFx0LnRoZW4oZnVuY3Rpb24gKHNlZ21lbnQpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHNlZ21lbnQuZG9TZWdtZW50KHRleHQpO1xuXHRcdH0pXG5cdFx0LnRhcChmdW5jdGlvbiAoZGF0YSlcblx0XHR7XG5cdFx0XHRyZXR1cm4gZGVidWdfdG9rZW4oZGF0YSlcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbGVTZWdtZW50KGZpbGU6IHN0cmluZywgb3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucylcbntcblx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUocmVhZEZpbGUoZmlsZSkpXG5cdFx0LnRoZW4oZnVuY3Rpb24gKGJ1Zilcblx0XHR7XG5cdFx0XHRyZXR1cm4gdGV4dFNlZ21lbnQoYnVmLnRvU3RyaW5nKCksIG9wdGlvbnMpO1xuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc1RleHQodGV4dDogc3RyaW5nLCBvcHRpb25zPzogSVNlZ21lbnRDTElPcHRpb25zKVxue1xuXHRpZiAoIXRleHQubGVuZ3RoIHx8ICF0ZXh0LnJlcGxhY2UoL1xccysvZywgJycpLmxlbmd0aClcblx0e1xuXHRcdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKCcnKTtcblx0fVxuXG5cdHJldHVybiB0ZXh0U2VnbWVudCh0ZXh0LCBvcHRpb25zKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChkYXRhKVxuXHRcdHtcblx0XHRcdGxldCB0ZXh0ID0gc3RyaW5naWZ5KGRhdGEpO1xuXHRcdFx0aWYgKG9wdGlvbnMpXG5cdFx0XHR7XG5cdFx0XHRcdGlmIChvcHRpb25zLmNybGYpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAodHlwZW9mIG9wdGlvbnMuY3JsZiA9PT0gJ3N0cmluZycpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dGV4dCA9IGNybGYodGV4dCwgb3B0aW9ucy5jcmxmKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHRleHQgPSBjcmxmKHRleHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRmcmVlR0MoKTtcblxuXHRcdFx0cmV0dXJuIHRleHQ7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm9jZXNzRmlsZShmaWxlOiBzdHJpbmcsIG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpXG57XG5cdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKHJlYWRGaWxlKGZpbGUsIG9wdGlvbnMpKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChidWYpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHByb2Nlc3NUZXh0KGJ1Zi50b1N0cmluZygpLCBvcHRpb25zKTtcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGNsYXNzIFNlZ21lbnRDbGlFcnJvciBleHRlbmRzIEVycm9yXG57XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRGaWxlKGZpbGU6IHN0cmluZywgb3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucyk6IGJsdWViaXJkPEJ1ZmZlcj5cbntcblx0cmV0dXJuIG5ldyBibHVlYmlyZDxCdWZmZXI+KChyZXNvbHZlLCByZWplY3QpID0+XG5cdHtcblx0XHRpZiAoIWZzLmV4aXN0c1N5bmMoZmlsZSkpXG5cdFx0e1xuXHRcdFx0bGV0IGUgPSBuZXcgU2VnbWVudENsaUVycm9yKGBFTk9FTlQ6IG5vIHN1Y2ggZmlsZSBvciBkaXJlY3RvcnksIG9wZW4gJyR7ZmlsZX0nYCk7XG5cdFx0XHRyZWplY3QoZSlcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblxuXHRcdFx0ZnMucmVhZEZpbGUoZmlsZSkudGhlbihyZXNvbHZlKTtcblx0XHR9XG5cdH0pXG5cdFx0LnRhcChmdW5jdGlvbiAoYnVmKVxuXHRcdHtcblx0XHRcdGlmIChvcHRpb25zICYmIG9wdGlvbnMuZGlzYWJsZVdhcm4pXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0aWYgKCFidWYubGVuZ3RoKVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zb2xlLndhcm4oYOatpOaqlOahiOeEoeWFp+WuuWAsIGZpbGUpO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgY2hrID0gaWNvbnYuZGV0ZWN0KGJ1Zik7XG5cblx0XHRcdFx0aWYgKGNoay5lbmNvZGluZyAhPSAnVVRGLTgnICYmIGNoay5lbmNvZGluZyAhPSAnYXNjaWknKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29uc29sZS53YXJuKCfmraTmqpTmoYjlj6/og73kuI3mmK8gVVRGOCDoq4vmqqLmn6Xnt6jnorzmiJbliKnnlKggTWFkRWRpdCDnrYnlt6XlhbfovYnmj5snLCBjaGssIGZpbGUpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaXhPcHRpb25zKG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpOiBJU2VnbWVudENMSU9wdGlvbnNcbntcblx0b3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG5cblx0aWYgKHR5cGVvZiBvcHRpb25zLnR0bCAhPT0gJ251bWJlcicgfHwgb3B0aW9ucy50dGwgPCAxKVxuXHR7XG5cdFx0ZGVsZXRlIG9wdGlvbnMudHRsO1xuXHR9XG5cblx0cmV0dXJuIG9wdGlvbnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDYWNhY2hlKG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpXG57XG5cdHJldHVybiBuZXcgYmx1ZWJpcmQ8Q2FjYWNoZT4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0e1xuXHRcdGlmICghQ0FDSEVEX0NBQ0FDSEUpXG5cdFx0e1xuXHRcdFx0aWYgKG9wdGlvbnMgJiYgb3B0aW9ucy51c2VHbG9iYWxDYWNoZSlcblx0XHRcdHtcblx0XHRcdFx0Q0FDSEVEX0NBQ0FDSEUgPSBuZXcgQ2FjYWNoZSh7XG5cdFx0XHRcdFx0bmFtZTogUEFDS0FHRV9KU09OLm5hbWUsXG5cdFx0XHRcdFx0dXNlR2xvYmFsQ2FjaGU6IG9wdGlvbnMudXNlR2xvYmFsQ2FjaGUsXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRDQUNIRURfQ0FDQUNIRSA9IG5ldyBDYWNhY2hlKFBBQ0tBR0VfSlNPTi5uYW1lKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXNvbHZlKENBQ0hFRF9DQUNBQ0hFKVxuXHR9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc2V0U2VnbWVudCgpXG57XG5cdENBQ0hFRF9TRUdNRU5UID0gdm9pZCAwO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VnbWVudChvcHRpb25zPzogSVNlZ21lbnRDTElPcHRpb25zKVxue1xuXHRvcHRpb25zID0gZml4T3B0aW9ucyhvcHRpb25zKTtcblx0bGV0IHsgZGlzYWJsZUNhY2hlIH0gPSBvcHRpb25zO1xuXG5cdHJldHVybiBibHVlYmlyZFxuXHRcdC5yZXNvbHZlKClcblx0XHQudGhlbihhc3luYyBmdW5jdGlvbiAoKVxuXHRcdHtcblx0XHRcdGF3YWl0IGdldENhY2FjaGUob3B0aW9ucyk7XG5cblx0XHRcdGlmICghQ0FDSEVEX1NFR01FTlQpXG5cdFx0XHR7XG5cdFx0XHRcdENBQ0hFRF9TRUdNRU5UID0gbmV3IFNlZ21lbnQoe1xuXHRcdFx0XHRcdGF1dG9Dams6IHRydWUsXG5cblx0XHRcdFx0XHRvcHRpb25zRG9TZWdtZW50OiB7XG5cblx0XHRcdFx0XHRcdGNvbnZlcnRTeW5vbnltOiB0cnVlLFxuXG5cdFx0XHRcdFx0fSxcblxuXHRcdFx0XHRcdGFsbF9tb2Q6IHRydWUsXG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdGxldCBfb3B0aW9ucyA9IHtcblx0XHRcdFx0XHQvKipcblx0XHRcdFx0XHQgKiDplovllZ8gYWxsX21vZCDmiY3mnIPlnKjoh6rli5XovInlhaXmmYLljIXlkKsgWmh0U3lub255bU9wdGltaXplclxuXHRcdFx0XHRcdCAqL1xuXHRcdFx0XHRcdGFsbF9tb2Q6IHRydWUsXG5cdFx0XHRcdH07XG5cblx0XHRcdFx0bGV0IF9pbmZvID0gYXdhaXQgbG9hZENhY2hlSW5mbyhvcHRpb25zKTtcblxuXHRcdFx0XHRsZXQgdmVyc2lvbiA9IHtcblx0XHRcdFx0XHRbUEFDS0FHRV9KU09OLm5hbWVdOiBQQUNLQUdFX0pTT04udmVyc2lvbixcblx0XHRcdFx0XHQuLi5TZWdtZW50LnZlcnNpb25zLFxuXHRcdFx0XHRcdFtQQUNLQUdFX0pTT04ubmFtZV06IFBBQ0tBR0VfSlNPTi52ZXJzaW9uLFxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdGxldCBjYWNoZV9kYiA9IGF3YWl0IGxvYWRDYWNoZURiKG9wdGlvbnMpO1xuXG5cdFx0XHRcdGxldCBfZG9faW5pdDogYm9vbGVhbjtcblxuXHRcdFx0XHRpZiAoZGlzYWJsZUNhY2hlKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0X2RvX2luaXQgPSB0cnVlO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKHR5cGVvZiBfZG9faW5pdCA9PSAndW5kZWZpbmVkJ1xuXHRcdFx0XHRcdCYmIF9pbmZvXG5cdFx0XHRcdFx0JiYgX2luZm8uY3VycmVudFxuXHRcdFx0XHRcdCYmIF9pbmZvLmN1cnJlbnRbUEFDS0FHRV9KU09OLm5hbWVdXG5cdFx0XHRcdClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdE9iamVjdC5rZXlzKHZlcnNpb24pXG5cdFx0XHRcdFx0XHQuc29tZShrZXkgPT5cblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0bGV0IGJvb2wgPSBfaW5mb1trZXldICE9IHZlcnNpb25ba2V5XTtcblxuXHRcdFx0XHRcdFx0XHRpZiAoYm9vbClcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdGRlYnVnQ29uc29sZS5kZWJ1Zyhg5pys5qyh5Z+36KGM55qE54mI5pys6IiH5LiK5qyh57ep5a2Y55qE54mI5pys5LiN5ZCMYCk7XG5cdFx0XHRcdFx0XHRcdFx0X2RvX2luaXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0cmV0dXJuIGJvb2w7XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdDtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmICh0eXBlb2YgX2RvX2luaXQgPT0gJ3VuZGVmaW5lZCcgJiYgY2FjaGVfZGIpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoY2FjaGVfZGIuRElDVClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoYOi8ieWFpee3qeWtmOWtl+WFuGApO1xuXG5cdFx0XHRcdFx0XHR1c2VEZWZhdWx0KENBQ0hFRF9TRUdNRU5ULCB7XG5cdFx0XHRcdFx0XHRcdC4uLm9wdGlvbnMsXG5cdFx0XHRcdFx0XHRcdG5vZGljdDogdHJ1ZSxcblx0XHRcdFx0XHRcdFx0YWxsX21vZDogdHJ1ZSxcblx0XHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0XHRDQUNIRURfU0VHTUVOVC5ESUNUID0gY2FjaGVfZGIuRElDVDtcblxuXHRcdFx0XHRcdFx0Q0FDSEVEX1NFR01FTlQuaW5pdGVkID0gdHJ1ZTtcblxuXHRcdFx0XHRcdFx0X2RvX2luaXQgPSBmYWxzZTtcblxuXHRcdFx0XHRcdFx0Ly9jb25zb2xlLmRpcihDQUNIRURfU0VHTUVOVC5tb2R1bGVzKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAodHlwZW9mIF9kb19pbml0ID09ICd1bmRlZmluZWQnIHx8IF9kb19pbml0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0ZGVidWdDb25zb2xlLmRlYnVnKGDph43mlrDovInlhaXliIbmnpDlrZflhbhgKTtcblxuXHRcdFx0XHRcdENBQ0hFRF9TRUdNRU5ULmF1dG9Jbml0KF9vcHRpb25zKTtcblxuXHRcdFx0XHRcdF9kb19pbml0ID0gdHJ1ZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRDQUNIRURfU0VHTUVOVFxuXHRcdFx0XHRcdFx0LmxvYWRTeW5vbnltRGljdCgnc3lub255bScpXG5cdFx0XHRcdFx0XHQubG9hZFN5bm9ueW1EaWN0KCd6aHQuc3lub255bScsIGZhbHNlKVxuXG5cdFx0XHRcdFx0XHQubG9hZEJsYWNrbGlzdERpY3QoJ2JsYWNrbGlzdCcpXG5cdFx0XHRcdFx0XHQubG9hZEJsYWNrbGlzdE9wdGltaXplckRpY3QoJ2JsYWNrbGlzdC5uYW1lJylcblx0XHRcdFx0XHQ7XG5cblx0XHRcdFx0XHRDQUNIRURfU0VHTUVOVC5kb0JsYWNrbGlzdCgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IGRiX2RpY3QgPSBDQUNIRURfU0VHTUVOVC5nZXREaWN0RGF0YWJhc2UoJ1RBQkxFJywgdHJ1ZSk7XG5cdFx0XHRcdGRiX2RpY3QuVEFCTEUgPSBDQUNIRURfU0VHTUVOVC5ESUNUWydUQUJMRSddO1xuXHRcdFx0XHRkYl9kaWN0LlRBQkxFMiA9IENBQ0hFRF9TRUdNRU5ULkRJQ1RbJ1RBQkxFMiddO1xuXG5cdFx0XHRcdGRiX2RpY3Qub3B0aW9ucy5hdXRvQ2prID0gdHJ1ZTtcblxuXHRcdFx0XHQvL0NBQ0hFRF9TRUdNRU5ULmxvYWRTeW5vbnltRGljdCgnc3lub255bScsIHRydWUpO1xuXG5cdFx0XHRcdGxldCBzaXplX2RiX2RpY3QgPSBkYl9kaWN0LnNpemUoKTtcblxuXHRcdFx0XHRDQUNIRURfU0VHTUVOVC5sb2FkU3lub255bURpY3QoJ3N5bm9ueW0nLCB0cnVlKTtcblxuXHRcdFx0XHRsZXQgc2l6ZV9zZWdtZW50ID0gT2JqZWN0LmtleXMoQ0FDSEVEX1NFR01FTlQuZ2V0RGljdCgnU1lOT05ZTScpKS5sZW5ndGg7XG5cblx0XHRcdFx0ZGVidWdDb25zb2xlLmRlYnVnKCfkuLvlrZflhbjnuL3mlbgnLCBzaXplX2RiX2RpY3QpO1xuXHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoJ1N5bm9ueW0nLCBzaXplX3NlZ21lbnQpO1xuXG5cdFx0XHRcdF9pbmZvLmxhc3QgPSBPYmplY3QuYXNzaWduKHt9LCBfaW5mby5jdXJyZW50KTtcblxuXHRcdFx0XHRfaW5mby5jdXJyZW50ID0ge1xuXHRcdFx0XHRcdHNpemVfZGJfZGljdCxcblx0XHRcdFx0XHRzaXplX3NlZ21lbnQsXG5cdFx0XHRcdFx0c2l6ZV9kYl9kaWN0X2RpZmY6IHNpemVfZGJfZGljdCAtIChfaW5mby5sYXN0LnNpemVfZGJfZGljdCB8fCAwKSxcblx0XHRcdFx0XHRzaXplX3NlZ21lbnRfZGlmZjogc2l6ZV9zZWdtZW50IC0gKF9pbmZvLmxhc3Quc2l6ZV9zZWdtZW50IHx8IDApLFxuXG5cdFx0XHRcdFx0dmVyc2lvbixcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoX2luZm8pO1xuXG5cdFx0XHRcdGlmICghZGlzYWJsZUNhY2hlXG5cdFx0XHRcdFx0JiYgKF9kb19pbml0IHx8ICFjYWNoZV9kYiB8fCAhY2FjaGVfZGIuRElDVClcblx0XHRcdFx0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0YXdhaXQgQ0FDSEVEX0NBQ0FDSEUud3JpdGVKU09OKERCX0tFWSwge1xuXG5cdFx0XHRcdFx0XHQuLi5faW5mbyxcblxuXHRcdFx0XHRcdFx0RElDVDogQ0FDSEVEX1NFR01FTlQuRElDVCxcblx0XHRcdFx0XHR9IGFzIElEYXRhQ2FjaGUpO1xuXG5cdFx0XHRcdFx0ZGVidWdDb25zb2xlLmRlYnVnKGDnt6nlrZjlrZflhbjmlrwgJHtEQl9LRVl9YCwgQ0FDSEVEX0NBQ0FDSEUuY2FjaGVQYXRoKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGZyZWVHQygpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gQ0FDSEVEX1NFR01FTlQ7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURhdGFDYWNoZUluZm9cbntcblx0c2l6ZV9kYl9kaWN0PzogbnVtYmVyLFxuXHRzaXplX3NlZ21lbnQ/OiBudW1iZXIsXG5cdHNpemVfZGJfZGljdF9kaWZmPzogbnVtYmVyLFxuXHRzaXplX3NlZ21lbnRfZGlmZj86IG51bWJlcixcblxuXHR2ZXJzaW9uPzoge1xuXHRcdCdub3ZlbC1zZWdtZW50LWNsaSc/OiBzdHJpbmcsXG5cdFx0J25vdmVsLXNlZ21lbnQnPzogc3RyaW5nLFxuXHRcdCdzZWdtZW50LWRpY3QnPzogc3RyaW5nLFxuXHR9LFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElEYXRhQ2FjaGVcbntcblx0bGFzdD86IElEYXRhQ2FjaGVJbmZvLFxuXHRjdXJyZW50PzogSURhdGFDYWNoZUluZm8sXG5cdERJQ1Q/OiBhbnksXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkQ2FjaGVJbmZvKG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpXG57XG5cdHJldHVybiBibHVlYmlyZFxuXHRcdC5yZXNvbHZlKClcblx0XHQudGhlbihhc3luYyBmdW5jdGlvbiAoKVxuXHRcdHtcblx0XHRcdGF3YWl0IGdldENhY2FjaGUob3B0aW9ucyk7XG5cblx0XHRcdGxldCBoYXNfY2FjaGVfZGIgPSBhd2FpdCBDQUNIRURfQ0FDQUNIRS5oYXNEYXRhKERCX0tFWV9JTkZPKTtcblxuXHRcdFx0bGV0IGRhdGE6IElEYXRhQ2FjaGU7XG5cblx0XHRcdGlmIChoYXNfY2FjaGVfZGIpXG5cdFx0XHR7XG5cdFx0XHRcdGRhdGEgPSBhd2FpdCBDQUNIRURfQ0FDQUNIRVxuXHRcdFx0XHRcdC5yZWFkSlNPTjxJRGF0YUNhY2hlPihEQl9LRVlfSU5GTylcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbiAocmV0KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJldHVybiByZXQuanNvbjtcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHQ7XG5cdFx0XHR9XG5cblx0XHRcdGRhdGEgPSBkYXRhIHx8IHt9O1xuXG5cdFx0XHRkYXRhLmxhc3QgPSBkYXRhLmxhc3QgfHwge307XG5cdFx0XHRkYXRhLmN1cnJlbnQgPSBkYXRhLmN1cnJlbnQgfHwge307XG5cdFx0XHRkYXRhLmxhc3QudmVyc2lvbiA9IGRhdGEubGFzdC52ZXJzaW9uIHx8IHt9O1xuXHRcdFx0ZGF0YS5jdXJyZW50LnZlcnNpb24gPSBkYXRhLmN1cnJlbnQudmVyc2lvbiB8fCB7fTtcblxuXHRcdFx0cmV0dXJuIGRhdGE7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkQ2FjaGVEYihvcHRpb25zPzogSVNlZ21lbnRDTElPcHRpb25zKTogYmx1ZWJpcmQ8SURhdGFDYWNoZT5cbntcblx0b3B0aW9ucyA9IGZpeE9wdGlvbnMob3B0aW9ucyk7XG5cdGxldCB7IGRpc2FibGVDYWNoZSB9ID0gb3B0aW9ucztcblxuXHRpZiAoZGlzYWJsZUNhY2hlKVxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHQucmVzb2x2ZShudWxsKVxuXHRcdFx0O1xuXHR9XG5cblx0cmV0dXJuIGJsdWViaXJkXG5cdFx0LnJlc29sdmUoKVxuXHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uICgpXG5cdFx0e1xuXHRcdFx0YXdhaXQgZ2V0Q2FjYWNoZShvcHRpb25zKTtcblxuXHRcdFx0bGV0IGhhc19jYWNoZV9kYiA9IGF3YWl0IENBQ0hFRF9DQUNBQ0hFLmhhc0RhdGEoREJfS0VZLCB7XG5cdFx0XHRcdHR0bDogb3B0aW9ucy50dGwgPiAwID8gb3B0aW9ucy50dGwgOiBEQl9UVEwsXG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKGhhc19jYWNoZV9kYilcblx0XHRcdHtcblx0XHRcdFx0ZGVidWdDb25zb2xlLmRlYnVnKGDnmbznj77nt6nlrZggJHtEQl9LRVl9YCwgaGFzX2NhY2hlX2RiLnBhdGgpO1xuXG5cdFx0XHRcdHJldHVybiBDQUNIRURfQ0FDQUNIRVxuXHRcdFx0XHRcdC5yZWFkSlNPTjxJRGF0YUNhY2hlPihEQl9LRVkpXG5cdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24gKHJldClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcmV0Lmpzb247XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQ7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlQ2FjaGUob3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucylcbntcblx0cmV0dXJuIGdldENhY2FjaGUoZml4T3B0aW9ucyhvcHRpb25zKSlcblx0XHQudGFwKGFzeW5jIGZ1bmN0aW9uIChjYWNoZSlcblx0XHR7XG5cdFx0XHRhd2FpdCBjYWNoZS5jbGVhck1lbW9pemVkKCk7XG5cdFx0XHRhd2FpdCBjYWNoZS5yZW1vdmVBbGwoKTtcblx0XHR9KVxuXHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNldENhY2hlKClcbntcblx0Q0FDSEVEX0NBQ0FDSEUgPSB2b2lkIDBcbn1cbiJdfQ==