"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const crlf_normalize_1 = require("crlf-normalize");
const novel_segment_1 = require("novel-segment");
exports.stringify = novel_segment_1.stringify;
const bluebird = require("bluebird");
const fs = require("fs-iconv");
const lib_1 = require("novel-segment/lib");
const cache_1 = require("./lib/cache");
const util_1 = require("./lib/util");
exports.enableDebug = util_1.enableDebug;
const PACKAGE_JSON = require("./package.json");
const util_2 = require("novel-segment/lib/util");
const iconv = require("iconv-jschardet");
const min_1 = require("cjk-conv/lib/zh/convert/min");
let CACHED_SEGMENT;
let CACHED_CACACHE;
const DB_KEY = 'cache.db';
const DB_KEY_INFO = 'cache.info';
const DB_TTL = 3600 * 1000;
function textSegment(text, options) {
    return getSegment(options)
        .then(function (segment) {
        return segment.doSegment(text);
    })
        .tap(function (data) {
        return util_2.debug_token(data);
    });
}
exports.textSegment = textSegment;
function fileSegment(file, options) {
    return bluebird.resolve(readFile(file))
        .then(function (buf) {
        return textSegment(buf.toString(), options);
    });
}
exports.fileSegment = fileSegment;
function processText(text, options) {
    if (!text.length || !text.replace(/\s+/g, '').length) {
        return bluebird.resolve('');
    }
    return textSegment(text, options)
        .then(function (data) {
        let text = novel_segment_1.stringify(data);
        if (options) {
            if (options.crlf) {
                if (typeof options.crlf === 'string') {
                    text = crlf_normalize_1.default(text, options.crlf);
                }
                else {
                    text = crlf_normalize_1.default(text);
                }
            }
        }
        if (options.convertToZhTw) {
            text = min_1.cn2tw_min(text);
        }
        util_1.freeGC();
        return text;
    });
}
exports.processText = processText;
function processFile(file, options) {
    return bluebird.resolve(readFile(file, options))
        .then(function (buf) {
        return processText(buf.toString(), options);
    });
}
exports.processFile = processFile;
class SegmentCliError extends Error {
}
exports.SegmentCliError = SegmentCliError;
function readFile(file, options) {
    return bluebird.resolve().then(() => {
        if (!fs.existsSync(file)) {
            let e = new SegmentCliError(`ENOENT: no such file or directory, open '${file}'`);
            return bluebird.reject(e);
        }
        return fs.loadFile(file, {
            autoDecode: true,
        })
            .then(v => Buffer.from(v));
    })
        .tap(function (buf) {
        if (options && options.disableWarn) {
            return;
        }
        if (!buf.length) {
            util_1.console.warn(`此檔案無內容`, file);
        }
        else {
            let chk = iconv.detect(buf);
            if (chk.encoding != 'UTF-8' && chk.encoding != 'ascii') {
                util_1.console.warn('此檔案可能不是 UTF8 請檢查編碼或利用 MadEdit 等工具轉換', chk, file);
            }
        }
    });
}
exports.readFile = readFile;
function fixOptions(options) {
    options = options || {};
    if (typeof options.ttl !== 'number' || options.ttl < 1) {
        delete options.ttl;
    }
    return options;
}
exports.fixOptions = fixOptions;
function getCacache(options) {
    return new bluebird(function (resolve, reject) {
        if (!CACHED_CACACHE) {
            if (options && options.useGlobalCache) {
                CACHED_CACACHE = new cache_1.Cacache({
                    name: PACKAGE_JSON.name,
                    useGlobalCache: options.useGlobalCache,
                });
            }
            else {
                CACHED_CACACHE = new cache_1.Cacache(PACKAGE_JSON.name);
            }
        }
        resolve(CACHED_CACACHE);
    });
}
exports.getCacache = getCacache;
function resetSegment() {
    CACHED_SEGMENT = void 0;
}
exports.resetSegment = resetSegment;
function getSegment(options) {
    options = fixOptions(options);
    let { disableCache } = options;
    return bluebird
        .resolve()
        .then(async function () {
        await getCacache(options);
        if (!CACHED_SEGMENT) {
            CACHED_SEGMENT = new novel_segment_1.default({
                autoCjk: true,
                optionsDoSegment: {
                    convertSynonym: true,
                },
                all_mod: true,
            });
            let _options = {
                /**
                 * 開啟 all_mod 才會在自動載入時包含 ZhtSynonymOptimizer
                 */
                all_mod: true,
            };
            let _info = await loadCacheInfo(options);
            let version = {
                [PACKAGE_JSON.name]: PACKAGE_JSON.version,
                ...novel_segment_1.default.versions,
                [PACKAGE_JSON.name]: PACKAGE_JSON.version,
            };
            let cache_db = await loadCacheDb(options);
            let _do_init;
            if (disableCache) {
                _do_init = true;
            }
            if (typeof _do_init == 'undefined'
                && _info
                && _info.current
                && _info.current[PACKAGE_JSON.name]) {
                Object.keys(version)
                    .some(key => {
                    let bool = _info[key] != version[key];
                    if (bool) {
                        util_1.debugConsole.debug(`本次執行的版本與上次緩存的版本不同`);
                        _do_init = true;
                    }
                    return bool;
                });
            }
            if (typeof _do_init == 'undefined' && cache_db) {
                if (cache_db.DICT) {
                    util_1.debugConsole.debug(`載入緩存字典`);
                    lib_1.useDefault(CACHED_SEGMENT, {
                        ...options,
                        nodict: true,
                        all_mod: true,
                    });
                    CACHED_SEGMENT.DICT = cache_db.DICT;
                    CACHED_SEGMENT.inited = true;
                    _do_init = false;
                    //console.dir(CACHED_SEGMENT.modules);
                }
            }
            if (typeof _do_init == 'undefined' || _do_init) {
                util_1.debugConsole.debug(`重新載入分析字典`);
                CACHED_SEGMENT.autoInit(_options);
                _do_init = true;
            }
            else {
                CACHED_SEGMENT
                    .loadSynonymDict('synonym')
                    .loadSynonymDict('zht.synonym', false)
                    .loadBlacklistDict('blacklist')
                    .loadBlacklistOptimizerDict('blacklist.name');
                CACHED_SEGMENT.doBlacklist();
            }
            let db_dict = CACHED_SEGMENT.getDictDatabase('TABLE', true);
            db_dict.TABLE = CACHED_SEGMENT.DICT['TABLE'];
            db_dict.TABLE2 = CACHED_SEGMENT.DICT['TABLE2'];
            db_dict.options.autoCjk = true;
            //CACHED_SEGMENT.loadSynonymDict('synonym', true);
            let size_db_dict = db_dict.size();
            CACHED_SEGMENT.loadSynonymDict('synonym', true);
            let size_segment = Object.keys(CACHED_SEGMENT.getDict('SYNONYM')).length;
            util_1.debugConsole.debug('主字典總數', size_db_dict);
            util_1.debugConsole.debug('Synonym', size_segment);
            _info.last = Object.assign({}, _info.current);
            _info.current = {
                size_db_dict,
                size_segment,
                size_db_dict_diff: size_db_dict - (_info.last.size_db_dict || 0),
                size_segment_diff: size_segment - (_info.last.size_segment || 0),
                version,
            };
            util_1.debugConsole.debug(_info);
            if (!disableCache
                && (_do_init || !cache_db || !cache_db.DICT)) {
                await CACHED_CACACHE.writeJSON(DB_KEY, {
                    ..._info,
                    DICT: CACHED_SEGMENT.DICT,
                });
                util_1.debugConsole.debug(`緩存字典於 ${DB_KEY}`, CACHED_CACACHE.cachePath);
            }
            util_1.freeGC();
        }
        return CACHED_SEGMENT;
    });
}
exports.getSegment = getSegment;
function loadCacheInfo(options) {
    return bluebird
        .resolve()
        .then(async function () {
        await getCacache(options);
        let has_cache_db = await CACHED_CACACHE.hasData(DB_KEY_INFO);
        let data;
        if (has_cache_db) {
            data = await CACHED_CACACHE
                .readJSON(DB_KEY_INFO)
                .then(function (ret) {
                return ret.json;
            });
        }
        data = data || {};
        data.last = data.last || {};
        data.current = data.current || {};
        data.last.version = data.last.version || {};
        data.current.version = data.current.version || {};
        return data;
    });
}
exports.loadCacheInfo = loadCacheInfo;
function loadCacheDb(options) {
    options = fixOptions(options);
    let { disableCache } = options;
    if (disableCache) {
        return bluebird
            .resolve(null);
    }
    return bluebird
        .resolve()
        .then(async function () {
        await getCacache(options);
        let has_cache_db = await CACHED_CACACHE.hasData(DB_KEY, {
            ttl: options.ttl > 0 ? options.ttl : DB_TTL,
        });
        if (has_cache_db) {
            util_1.debugConsole.debug(`發現緩存 ${DB_KEY}`, has_cache_db.path);
            return CACHED_CACACHE
                .readJSON(DB_KEY)
                .then(function (ret) {
                return ret.json;
            });
        }
        return null;
    });
}
exports.loadCacheDb = loadCacheDb;
function removeCache(options) {
    return getCacache(fixOptions(options))
        .tap(async function (cache) {
        await cache.clearMemoized();
        await cache.removeAll();
    });
}
exports.removeCache = removeCache;
function resetCache() {
    CACHED_CACACHE = void 0;
}
exports.resetCache = resetCache;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLG1EQUFrQztBQUNsQyxpREFBbUQ7QUFrQjdCLG9CQWxCSix5QkFBUyxDQWtCSTtBQWpCL0IscUNBQXNDO0FBQ3RDLCtCQUErQjtBQUMvQiwyQ0FBK0M7QUFDL0MsdUNBQXNDO0FBQ3RDLHFDQUF5RjtBQWFoRixzQkFid0Msa0JBQVcsQ0FheEM7QUFacEIsK0NBQWdEO0FBQ2hELGlEQUFvRDtBQUNwRCx5Q0FBeUM7QUFDekMscURBQW1FO0FBRW5FLElBQUksY0FBMkQsQ0FBQztBQUNoRSxJQUFJLGNBQXVCLENBQUM7QUFFNUIsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDO0FBQzFCLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQztBQUNqQyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBcUIzQixTQUFnQixXQUFXLENBQUMsSUFBWSxFQUFFLE9BQTRCO0lBRXJFLE9BQU8sVUFBVSxDQUFDLE9BQU8sQ0FBQztTQUN4QixJQUFJLENBQUMsVUFBVSxPQUFPO1FBRXRCLE9BQU8sT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUM7U0FDRCxHQUFHLENBQUMsVUFBVSxJQUFJO1FBRWxCLE9BQU8sa0JBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN6QixDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUFaRCxrQ0FZQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxJQUFZLEVBQUUsT0FBNEI7SUFFckUsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNyQyxJQUFJLENBQUMsVUFBVSxHQUFHO1FBRWxCLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM3QyxDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUFSRCxrQ0FRQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxJQUFZLEVBQUUsT0FBNEI7SUFFckUsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQ3BEO1FBQ0MsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQzVCO0lBRUQsT0FBTyxXQUFXLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQztTQUMvQixJQUFJLENBQUMsVUFBVSxJQUFJO1FBRW5CLElBQUksSUFBSSxHQUFHLHlCQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0IsSUFBSSxPQUFPLEVBQ1g7WUFDQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEVBQ2hCO2dCQUNDLElBQUksT0FBTyxPQUFPLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFDcEM7b0JBQ0MsSUFBSSxHQUFHLHdCQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDaEM7cUJBRUQ7b0JBQ0MsSUFBSSxHQUFHLHdCQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ2xCO2FBQ0Q7U0FDRDtRQUVELElBQUksT0FBTyxDQUFDLGFBQWEsRUFDekI7WUFDQyxJQUFJLEdBQUcsZUFBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3ZCO1FBRUQsYUFBTSxFQUFFLENBQUM7UUFFVCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQXBDRCxrQ0FvQ0M7QUFFRCxTQUFnQixXQUFXLENBQUMsSUFBWSxFQUFFLE9BQTRCO0lBRXJFLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzlDLElBQUksQ0FBQyxVQUFVLEdBQUc7UUFFbEIsT0FBTyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQVJELGtDQVFDO0FBRUQsTUFBYSxlQUFnQixTQUFRLEtBQUs7Q0FHekM7QUFIRCwwQ0FHQztBQUVELFNBQWdCLFFBQVEsQ0FBQyxJQUFZLEVBQUUsT0FBNEI7SUFFbEUsT0FBTyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUVsQyxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFDeEI7WUFDQyxJQUFJLENBQUMsR0FBRyxJQUFJLGVBQWUsQ0FBQyw0Q0FBNEMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNqRixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7U0FDekI7UUFFRCxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ3ZCLFVBQVUsRUFBRSxJQUFJO1NBQ2hCLENBQUM7YUFDRCxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQ3pCO0lBQ0gsQ0FBQyxDQUFDO1NBQ0QsR0FBRyxDQUFDLFVBQVUsR0FBRztRQUVqQixJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBVyxFQUNsQztZQUNDLE9BQU87U0FDUDtRQUVELElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUNmO1lBQ0MsY0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDN0I7YUFFRDtZQUNDLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFNUIsSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLE9BQU8sSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLE9BQU8sRUFDdEQ7Z0JBQ0MsY0FBTyxDQUFDLElBQUksQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDL0Q7U0FDRDtJQUNGLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQXRDRCw0QkFzQ0M7QUFFRCxTQUFnQixVQUFVLENBQUMsT0FBNEI7SUFFdEQsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFeEIsSUFBSSxPQUFPLE9BQU8sQ0FBQyxHQUFHLEtBQUssUUFBUSxJQUFJLE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxFQUN0RDtRQUNDLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQztLQUNuQjtJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUM7QUFWRCxnQ0FVQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxPQUE0QjtJQUV0RCxPQUFPLElBQUksUUFBUSxDQUFVLFVBQVUsT0FBTyxFQUFFLE1BQU07UUFFckQsSUFBSSxDQUFDLGNBQWMsRUFDbkI7WUFDQyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsY0FBYyxFQUNyQztnQkFDQyxjQUFjLEdBQUcsSUFBSSxlQUFPLENBQUM7b0JBQzVCLElBQUksRUFBRSxZQUFZLENBQUMsSUFBSTtvQkFDdkIsY0FBYyxFQUFFLE9BQU8sQ0FBQyxjQUFjO2lCQUN0QyxDQUFDLENBQUM7YUFDSDtpQkFFRDtnQkFDQyxjQUFjLEdBQUcsSUFBSSxlQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2hEO1NBQ0Q7UUFFRCxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUE7SUFDeEIsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDO0FBckJELGdDQXFCQztBQUVELFNBQWdCLFlBQVk7SUFFM0IsY0FBYyxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ3pCLENBQUM7QUFIRCxvQ0FHQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxPQUE0QjtJQUV0RCxPQUFPLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlCLElBQUksRUFBRSxZQUFZLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFFL0IsT0FBTyxRQUFRO1NBQ2IsT0FBTyxFQUFFO1NBQ1QsSUFBSSxDQUFDLEtBQUs7UUFFVixNQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUxQixJQUFJLENBQUMsY0FBYyxFQUNuQjtZQUNDLGNBQWMsR0FBRyxJQUFJLHVCQUFPLENBQUM7Z0JBQzVCLE9BQU8sRUFBRSxJQUFJO2dCQUViLGdCQUFnQixFQUFFO29CQUVqQixjQUFjLEVBQUUsSUFBSTtpQkFFcEI7Z0JBRUQsT0FBTyxFQUFFLElBQUk7YUFDYixDQUFDLENBQUM7WUFFSCxJQUFJLFFBQVEsR0FBRztnQkFDZDs7bUJBRUc7Z0JBQ0gsT0FBTyxFQUFFLElBQUk7YUFDYixDQUFDO1lBRUYsSUFBSSxLQUFLLEdBQUcsTUFBTSxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFekMsSUFBSSxPQUFPLEdBQUc7Z0JBQ2IsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsWUFBWSxDQUFDLE9BQU87Z0JBQ3pDLEdBQUcsdUJBQU8sQ0FBQyxRQUFRO2dCQUNuQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxZQUFZLENBQUMsT0FBTzthQUN6QyxDQUFDO1lBRUYsSUFBSSxRQUFRLEdBQUcsTUFBTSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFMUMsSUFBSSxRQUFpQixDQUFDO1lBRXRCLElBQUksWUFBWSxFQUNoQjtnQkFDQyxRQUFRLEdBQUcsSUFBSSxDQUFDO2FBQ2hCO1lBRUQsSUFBSSxPQUFPLFFBQVEsSUFBSSxXQUFXO21CQUM5QixLQUFLO21CQUNMLEtBQUssQ0FBQyxPQUFPO21CQUNiLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUVwQztnQkFDQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztxQkFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUVYLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBRXRDLElBQUksSUFBSSxFQUNSO3dCQUNDLG1CQUFZLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7d0JBQ3hDLFFBQVEsR0FBRyxJQUFJLENBQUM7cUJBQ2hCO29CQUVELE9BQU8sSUFBSSxDQUFDO2dCQUNiLENBQUMsQ0FBQyxDQUNGO2FBQ0Q7WUFFRCxJQUFJLE9BQU8sUUFBUSxJQUFJLFdBQVcsSUFBSSxRQUFRLEVBQzlDO2dCQUNDLElBQUksUUFBUSxDQUFDLElBQUksRUFDakI7b0JBQ0MsbUJBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBRTdCLGdCQUFVLENBQUMsY0FBYyxFQUFFO3dCQUMxQixHQUFHLE9BQU87d0JBQ1YsTUFBTSxFQUFFLElBQUk7d0JBQ1osT0FBTyxFQUFFLElBQUk7cUJBQ2IsQ0FBQyxDQUFDO29CQUVILGNBQWMsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztvQkFFcEMsY0FBYyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7b0JBRTdCLFFBQVEsR0FBRyxLQUFLLENBQUM7b0JBRWpCLHNDQUFzQztpQkFDdEM7YUFDRDtZQUVELElBQUksT0FBTyxRQUFRLElBQUksV0FBVyxJQUFJLFFBQVEsRUFDOUM7Z0JBQ0MsbUJBQVksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBRS9CLGNBQWMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBRWxDLFFBQVEsR0FBRyxJQUFJLENBQUM7YUFDaEI7aUJBRUQ7Z0JBQ0MsY0FBYztxQkFDWixlQUFlLENBQUMsU0FBUyxDQUFDO3FCQUMxQixlQUFlLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQztxQkFFckMsaUJBQWlCLENBQUMsV0FBVyxDQUFDO3FCQUM5QiwwQkFBMEIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUM3QztnQkFFRCxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDN0I7WUFFRCxJQUFJLE9BQU8sR0FBRyxjQUFjLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM1RCxPQUFPLENBQUMsS0FBSyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0MsT0FBTyxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRS9DLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztZQUUvQixrREFBa0Q7WUFFbEQsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRWxDLGNBQWMsQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRWhELElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUV6RSxtQkFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDMUMsbUJBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBRTVDLEtBQUssQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRTlDLEtBQUssQ0FBQyxPQUFPLEdBQUc7Z0JBQ2YsWUFBWTtnQkFDWixZQUFZO2dCQUNaLGlCQUFpQixFQUFFLFlBQVksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQztnQkFDaEUsaUJBQWlCLEVBQUUsWUFBWSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDO2dCQUVoRSxPQUFPO2FBQ1AsQ0FBQztZQUVGLG1CQUFZLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTFCLElBQUksQ0FBQyxZQUFZO21CQUNiLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUU3QztnQkFDQyxNQUFNLGNBQWMsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO29CQUV0QyxHQUFHLEtBQUs7b0JBRVIsSUFBSSxFQUFFLGNBQWMsQ0FBQyxJQUFJO2lCQUNYLENBQUMsQ0FBQztnQkFFakIsbUJBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxNQUFNLEVBQUUsRUFBRSxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDaEU7WUFFRCxhQUFNLEVBQUUsQ0FBQztTQUNUO1FBRUQsT0FBTyxjQUFjLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQ0Q7QUFDSCxDQUFDO0FBcEtELGdDQW9LQztBQXVCRCxTQUFnQixhQUFhLENBQUMsT0FBNEI7SUFFekQsT0FBTyxRQUFRO1NBQ2IsT0FBTyxFQUFFO1NBQ1QsSUFBSSxDQUFDLEtBQUs7UUFFVixNQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUUxQixJQUFJLFlBQVksR0FBRyxNQUFNLGNBQWMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFN0QsSUFBSSxJQUFnQixDQUFDO1FBRXJCLElBQUksWUFBWSxFQUNoQjtZQUNDLElBQUksR0FBRyxNQUFNLGNBQWM7aUJBQ3pCLFFBQVEsQ0FBYSxXQUFXLENBQUM7aUJBQ2pDLElBQUksQ0FBQyxVQUFVLEdBQUc7Z0JBRWxCLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNqQixDQUFDLENBQUMsQ0FDRjtTQUNEO1FBRUQsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFFbEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFFbEQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUFqQ0Qsc0NBaUNDO0FBRUQsU0FBZ0IsV0FBVyxDQUFDLE9BQTRCO0lBRXZELE9BQU8sR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsSUFBSSxFQUFFLFlBQVksRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUUvQixJQUFJLFlBQVksRUFDaEI7UUFDQyxPQUFPLFFBQVE7YUFDYixPQUFPLENBQUMsSUFBSSxDQUFDLENBQ2I7S0FDRjtJQUVELE9BQU8sUUFBUTtTQUNiLE9BQU8sRUFBRTtTQUNULElBQUksQ0FBQyxLQUFLO1FBRVYsTUFBTSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFMUIsSUFBSSxZQUFZLEdBQUcsTUFBTSxjQUFjLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUN2RCxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU07U0FDM0MsQ0FBQyxDQUFDO1FBRUgsSUFBSSxZQUFZLEVBQ2hCO1lBQ0MsbUJBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxNQUFNLEVBQUUsRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFeEQsT0FBTyxjQUFjO2lCQUNuQixRQUFRLENBQWEsTUFBTSxDQUFDO2lCQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHO2dCQUVsQixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDakIsQ0FBQyxDQUFDLENBQ0Q7U0FDRjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQyxDQUFDLENBQ0Q7QUFDSCxDQUFDO0FBdENELGtDQXNDQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxPQUE0QjtJQUV2RCxPQUFPLFVBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDcEMsR0FBRyxDQUFDLEtBQUssV0FBVyxLQUFLO1FBRXpCLE1BQU0sS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQzVCLE1BQU0sS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQVRELGtDQVNDO0FBRUQsU0FBZ0IsVUFBVTtJQUV6QixjQUFjLEdBQUcsS0FBSyxDQUFDLENBQUE7QUFDeEIsQ0FBQztBQUhELGdDQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNhY2FjaGUgPSByZXF1aXJlKCdjYWNhY2hlJyk7XG5pbXBvcnQgY3JsZiBmcm9tICdjcmxmLW5vcm1hbGl6ZSc7XG5pbXBvcnQgU2VnbWVudCwgeyBzdHJpbmdpZnkgfSBmcm9tICdub3ZlbC1zZWdtZW50JztcbmltcG9ydCBibHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1pY29udic7XG5pbXBvcnQgeyB1c2VEZWZhdWx0IH0gZnJvbSAnbm92ZWwtc2VnbWVudC9saWInO1xuaW1wb3J0IHsgQ2FjYWNoZSB9IGZyb20gJy4vbGliL2NhY2hlJztcbmltcG9ydCB7IGNvbnNvbGUsIGRlYnVnQ29uc29sZSwgZ2V0Q2FjaGVEaXJQYXRoLCBlbmFibGVEZWJ1ZywgZnJlZUdDIH0gZnJvbSAnLi9saWIvdXRpbCc7XG5pbXBvcnQgUEFDS0FHRV9KU09OID0gcmVxdWlyZSgnLi9wYWNrYWdlLmpzb24nKTtcbmltcG9ydCB7IGRlYnVnX3Rva2VuIH0gZnJvbSAnbm92ZWwtc2VnbWVudC9saWIvdXRpbCdcbmltcG9ydCAqIGFzIGljb252IGZyb20gJ2ljb252LWpzY2hhcmRldCc7XG5pbXBvcnQgeyBjbjJ0d19taW4sIHR3MmNuX21pbiB9IGZyb20gJ2Nqay1jb252L2xpYi96aC9jb252ZXJ0L21pbic7XG5cbmxldCBDQUNIRURfU0VHTUVOVDogaW1wb3J0KFwibm92ZWwtc2VnbWVudC9saWIvU2VnbWVudFwiKS5TZWdtZW50O1xubGV0IENBQ0hFRF9DQUNBQ0hFOiBDYWNhY2hlO1xuXG5jb25zdCBEQl9LRVkgPSAnY2FjaGUuZGInO1xuY29uc3QgREJfS0VZX0lORk8gPSAnY2FjaGUuaW5mbyc7XG5jb25zdCBEQl9UVEwgPSAzNjAwICogMTAwMDtcblxuZXhwb3J0IHsgZW5hYmxlRGVidWcsIHN0cmluZ2lmeSB9XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNlZ21lbnRDTElPcHRpb25zXG57XG5cdC8qKlxuXHQgKiDmoLzlvI/ljJbliIbooYznrKbomZ9cblx0ICovXG5cdGNybGY/OiBzdHJpbmcgfCBib29sZWFuLFxuXG5cdHVzZUdsb2JhbENhY2hlPzogYm9vbGVhbixcblx0ZGlzYWJsZUNhY2hlPzogYm9vbGVhbixcblxuXHRkaXNhYmxlV2Fybj86IGJvb2xlYW4sXG5cblx0dHRsPzogbnVtYmVyLFxuXG5cdGNvbnZlcnRUb1poVHc/OiBib29sZWFuLFxufVxuXG5leHBvcnQgZnVuY3Rpb24gdGV4dFNlZ21lbnQodGV4dDogc3RyaW5nLCBvcHRpb25zPzogSVNlZ21lbnRDTElPcHRpb25zKVxue1xuXHRyZXR1cm4gZ2V0U2VnbWVudChvcHRpb25zKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChzZWdtZW50KVxuXHRcdHtcblx0XHRcdHJldHVybiBzZWdtZW50LmRvU2VnbWVudCh0ZXh0KTtcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKGRhdGEpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGRlYnVnX3Rva2VuKGRhdGEpXG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWxlU2VnbWVudChmaWxlOiBzdHJpbmcsIG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpXG57XG5cdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKHJlYWRGaWxlKGZpbGUpKVxuXHRcdC50aGVuKGZ1bmN0aW9uIChidWYpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHRleHRTZWdtZW50KGJ1Zi50b1N0cmluZygpLCBvcHRpb25zKTtcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHRleHQ6IHN0cmluZywgb3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucylcbntcblx0aWYgKCF0ZXh0Lmxlbmd0aCB8fCAhdGV4dC5yZXBsYWNlKC9cXHMrL2csICcnKS5sZW5ndGgpXG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZSgnJyk7XG5cdH1cblxuXHRyZXR1cm4gdGV4dFNlZ21lbnQodGV4dCwgb3B0aW9ucylcblx0XHQudGhlbihmdW5jdGlvbiAoZGF0YSlcblx0XHR7XG5cdFx0XHRsZXQgdGV4dCA9IHN0cmluZ2lmeShkYXRhKTtcblx0XHRcdGlmIChvcHRpb25zKVxuXHRcdFx0e1xuXHRcdFx0XHRpZiAob3B0aW9ucy5jcmxmKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKHR5cGVvZiBvcHRpb25zLmNybGYgPT09ICdzdHJpbmcnKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHRleHQgPSBjcmxmKHRleHQsIG9wdGlvbnMuY3JsZik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHR0ZXh0ID0gY3JsZih0ZXh0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0aWYgKG9wdGlvbnMuY29udmVydFRvWmhUdylcblx0XHRcdHtcblx0XHRcdFx0dGV4dCA9IGNuMnR3X21pbih0ZXh0KTtcblx0XHRcdH1cblxuXHRcdFx0ZnJlZUdDKCk7XG5cblx0XHRcdHJldHVybiB0ZXh0O1xuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc0ZpbGUoZmlsZTogc3RyaW5nLCBvcHRpb25zPzogSVNlZ21lbnRDTElPcHRpb25zKVxue1xuXHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZShyZWFkRmlsZShmaWxlLCBvcHRpb25zKSlcblx0XHQudGhlbihmdW5jdGlvbiAoYnVmKVxuXHRcdHtcblx0XHRcdHJldHVybiBwcm9jZXNzVGV4dChidWYudG9TdHJpbmcoKSwgb3B0aW9ucyk7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBjbGFzcyBTZWdtZW50Q2xpRXJyb3IgZXh0ZW5kcyBFcnJvclxue1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkRmlsZShmaWxlOiBzdHJpbmcsIG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpOiBibHVlYmlyZDxCdWZmZXI+XG57XG5cdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKCkudGhlbigoKSA9PlxuXHRcdHtcblx0XHRcdGlmICghZnMuZXhpc3RzU3luYyhmaWxlKSlcblx0XHRcdHtcblx0XHRcdFx0bGV0IGUgPSBuZXcgU2VnbWVudENsaUVycm9yKGBFTk9FTlQ6IG5vIHN1Y2ggZmlsZSBvciBkaXJlY3RvcnksIG9wZW4gJyR7ZmlsZX0nYCk7XG5cdFx0XHRcdHJldHVybiBibHVlYmlyZC5yZWplY3QoZSlcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGZzLmxvYWRGaWxlKGZpbGUsIHtcblx0XHRcdFx0XHRhdXRvRGVjb2RlOiB0cnVlLFxuXHRcdFx0XHR9KVxuXHRcdFx0XHQudGhlbih2ID0+IEJ1ZmZlci5mcm9tKHYpKVxuXHRcdFx0XHQ7XG5cdFx0fSlcblx0XHQudGFwKGZ1bmN0aW9uIChidWYpXG5cdFx0e1xuXHRcdFx0aWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5kaXNhYmxlV2Fybilcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIWJ1Zi5sZW5ndGgpXG5cdFx0XHR7XG5cdFx0XHRcdGNvbnNvbGUud2Fybihg5q2k5qqU5qGI54Sh5YWn5a65YCwgZmlsZSk7XG5cdFx0XHR9XG5cdFx0XHRlbHNlXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBjaGsgPSBpY29udi5kZXRlY3QoYnVmKTtcblxuXHRcdFx0XHRpZiAoY2hrLmVuY29kaW5nICE9ICdVVEYtOCcgJiYgY2hrLmVuY29kaW5nICE9ICdhc2NpaScpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRjb25zb2xlLndhcm4oJ+atpOaqlOahiOWPr+iDveS4jeaYryBVVEY4IOiri+aqouafpee3qOeivOaIluWIqeeUqCBNYWRFZGl0IOetieW3peWFt+i9ieaPmycsIGNoaywgZmlsZSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpeE9wdGlvbnMob3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucyk6IElTZWdtZW50Q0xJT3B0aW9uc1xue1xuXHRvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcblxuXHRpZiAodHlwZW9mIG9wdGlvbnMudHRsICE9PSAnbnVtYmVyJyB8fCBvcHRpb25zLnR0bCA8IDEpXG5cdHtcblx0XHRkZWxldGUgb3B0aW9ucy50dGw7XG5cdH1cblxuXHRyZXR1cm4gb3B0aW9ucztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENhY2FjaGUob3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucylcbntcblx0cmV0dXJuIG5ldyBibHVlYmlyZDxDYWNhY2hlPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KVxuXHR7XG5cdFx0aWYgKCFDQUNIRURfQ0FDQUNIRSlcblx0XHR7XG5cdFx0XHRpZiAob3B0aW9ucyAmJiBvcHRpb25zLnVzZUdsb2JhbENhY2hlKVxuXHRcdFx0e1xuXHRcdFx0XHRDQUNIRURfQ0FDQUNIRSA9IG5ldyBDYWNhY2hlKHtcblx0XHRcdFx0XHRuYW1lOiBQQUNLQUdFX0pTT04ubmFtZSxcblx0XHRcdFx0XHR1c2VHbG9iYWxDYWNoZTogb3B0aW9ucy51c2VHbG9iYWxDYWNoZSxcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0XHRlbHNlXG5cdFx0XHR7XG5cdFx0XHRcdENBQ0hFRF9DQUNBQ0hFID0gbmV3IENhY2FjaGUoUEFDS0FHRV9KU09OLm5hbWUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJlc29sdmUoQ0FDSEVEX0NBQ0FDSEUpXG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRTZWdtZW50KClcbntcblx0Q0FDSEVEX1NFR01FTlQgPSB2b2lkIDA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTZWdtZW50KG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpXG57XG5cdG9wdGlvbnMgPSBmaXhPcHRpb25zKG9wdGlvbnMpO1xuXHRsZXQgeyBkaXNhYmxlQ2FjaGUgfSA9IG9wdGlvbnM7XG5cblx0cmV0dXJuIGJsdWViaXJkXG5cdFx0LnJlc29sdmUoKVxuXHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uICgpXG5cdFx0e1xuXHRcdFx0YXdhaXQgZ2V0Q2FjYWNoZShvcHRpb25zKTtcblxuXHRcdFx0aWYgKCFDQUNIRURfU0VHTUVOVClcblx0XHRcdHtcblx0XHRcdFx0Q0FDSEVEX1NFR01FTlQgPSBuZXcgU2VnbWVudCh7XG5cdFx0XHRcdFx0YXV0b0NqazogdHJ1ZSxcblxuXHRcdFx0XHRcdG9wdGlvbnNEb1NlZ21lbnQ6IHtcblxuXHRcdFx0XHRcdFx0Y29udmVydFN5bm9ueW06IHRydWUsXG5cblx0XHRcdFx0XHR9LFxuXG5cdFx0XHRcdFx0YWxsX21vZDogdHJ1ZSxcblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0bGV0IF9vcHRpb25zID0ge1xuXHRcdFx0XHRcdC8qKlxuXHRcdFx0XHRcdCAqIOmWi+WVnyBhbGxfbW9kIOaJjeacg+WcqOiHquWLlei8ieWFpeaZguWMheWQqyBaaHRTeW5vbnltT3B0aW1pemVyXG5cdFx0XHRcdFx0ICovXG5cdFx0XHRcdFx0YWxsX21vZDogdHJ1ZSxcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRsZXQgX2luZm8gPSBhd2FpdCBsb2FkQ2FjaGVJbmZvKG9wdGlvbnMpO1xuXG5cdFx0XHRcdGxldCB2ZXJzaW9uID0ge1xuXHRcdFx0XHRcdFtQQUNLQUdFX0pTT04ubmFtZV06IFBBQ0tBR0VfSlNPTi52ZXJzaW9uLFxuXHRcdFx0XHRcdC4uLlNlZ21lbnQudmVyc2lvbnMsXG5cdFx0XHRcdFx0W1BBQ0tBR0VfSlNPTi5uYW1lXTogUEFDS0FHRV9KU09OLnZlcnNpb24sXG5cdFx0XHRcdH07XG5cblx0XHRcdFx0bGV0IGNhY2hlX2RiID0gYXdhaXQgbG9hZENhY2hlRGIob3B0aW9ucyk7XG5cblx0XHRcdFx0bGV0IF9kb19pbml0OiBib29sZWFuO1xuXG5cdFx0XHRcdGlmIChkaXNhYmxlQ2FjaGUpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRfZG9faW5pdCA9IHRydWU7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAodHlwZW9mIF9kb19pbml0ID09ICd1bmRlZmluZWQnXG5cdFx0XHRcdFx0JiYgX2luZm9cblx0XHRcdFx0XHQmJiBfaW5mby5jdXJyZW50XG5cdFx0XHRcdFx0JiYgX2luZm8uY3VycmVudFtQQUNLQUdFX0pTT04ubmFtZV1cblx0XHRcdFx0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0T2JqZWN0LmtleXModmVyc2lvbilcblx0XHRcdFx0XHRcdC5zb21lKGtleSA9PlxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRsZXQgYm9vbCA9IF9pbmZvW2tleV0gIT0gdmVyc2lvbltrZXldO1xuXG5cdFx0XHRcdFx0XHRcdGlmIChib29sKVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0ZGVidWdDb25zb2xlLmRlYnVnKGDmnKzmrKHln7fooYznmoTniYjmnKzoiIfkuIrmrKHnt6nlrZjnmoTniYjmnKzkuI3lkIxgKTtcblx0XHRcdFx0XHRcdFx0XHRfZG9faW5pdCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gYm9vbDtcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0O1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKHR5cGVvZiBfZG9faW5pdCA9PSAndW5kZWZpbmVkJyAmJiBjYWNoZV9kYilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmIChjYWNoZV9kYi5ESUNUKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGRlYnVnQ29uc29sZS5kZWJ1Zyhg6LyJ5YWl57ep5a2Y5a2X5YW4YCk7XG5cblx0XHRcdFx0XHRcdHVzZURlZmF1bHQoQ0FDSEVEX1NFR01FTlQsIHtcblx0XHRcdFx0XHRcdFx0Li4ub3B0aW9ucyxcblx0XHRcdFx0XHRcdFx0bm9kaWN0OiB0cnVlLFxuXHRcdFx0XHRcdFx0XHRhbGxfbW9kOiB0cnVlLFxuXHRcdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRcdENBQ0hFRF9TRUdNRU5ULkRJQ1QgPSBjYWNoZV9kYi5ESUNUO1xuXG5cdFx0XHRcdFx0XHRDQUNIRURfU0VHTUVOVC5pbml0ZWQgPSB0cnVlO1xuXG5cdFx0XHRcdFx0XHRfZG9faW5pdCA9IGZhbHNlO1xuXG5cdFx0XHRcdFx0XHQvL2NvbnNvbGUuZGlyKENBQ0hFRF9TRUdNRU5ULm1vZHVsZXMpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmICh0eXBlb2YgX2RvX2luaXQgPT0gJ3VuZGVmaW5lZCcgfHwgX2RvX2luaXQpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoYOmHjeaWsOi8ieWFpeWIhuaekOWtl+WFuGApO1xuXG5cdFx0XHRcdFx0Q0FDSEVEX1NFR01FTlQuYXV0b0luaXQoX29wdGlvbnMpO1xuXG5cdFx0XHRcdFx0X2RvX2luaXQgPSB0cnVlO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Vcblx0XHRcdFx0e1xuXHRcdFx0XHRcdENBQ0hFRF9TRUdNRU5UXG5cdFx0XHRcdFx0XHQubG9hZFN5bm9ueW1EaWN0KCdzeW5vbnltJylcblx0XHRcdFx0XHRcdC5sb2FkU3lub255bURpY3QoJ3podC5zeW5vbnltJywgZmFsc2UpXG5cblx0XHRcdFx0XHRcdC5sb2FkQmxhY2tsaXN0RGljdCgnYmxhY2tsaXN0Jylcblx0XHRcdFx0XHRcdC5sb2FkQmxhY2tsaXN0T3B0aW1pemVyRGljdCgnYmxhY2tsaXN0Lm5hbWUnKVxuXHRcdFx0XHRcdDtcblxuXHRcdFx0XHRcdENBQ0hFRF9TRUdNRU5ULmRvQmxhY2tsaXN0KCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgZGJfZGljdCA9IENBQ0hFRF9TRUdNRU5ULmdldERpY3REYXRhYmFzZSgnVEFCTEUnLCB0cnVlKTtcblx0XHRcdFx0ZGJfZGljdC5UQUJMRSA9IENBQ0hFRF9TRUdNRU5ULkRJQ1RbJ1RBQkxFJ107XG5cdFx0XHRcdGRiX2RpY3QuVEFCTEUyID0gQ0FDSEVEX1NFR01FTlQuRElDVFsnVEFCTEUyJ107XG5cblx0XHRcdFx0ZGJfZGljdC5vcHRpb25zLmF1dG9DamsgPSB0cnVlO1xuXG5cdFx0XHRcdC8vQ0FDSEVEX1NFR01FTlQubG9hZFN5bm9ueW1EaWN0KCdzeW5vbnltJywgdHJ1ZSk7XG5cblx0XHRcdFx0bGV0IHNpemVfZGJfZGljdCA9IGRiX2RpY3Quc2l6ZSgpO1xuXG5cdFx0XHRcdENBQ0hFRF9TRUdNRU5ULmxvYWRTeW5vbnltRGljdCgnc3lub255bScsIHRydWUpO1xuXG5cdFx0XHRcdGxldCBzaXplX3NlZ21lbnQgPSBPYmplY3Qua2V5cyhDQUNIRURfU0VHTUVOVC5nZXREaWN0KCdTWU5PTllNJykpLmxlbmd0aDtcblxuXHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoJ+S4u+Wtl+WFuOe4veaVuCcsIHNpemVfZGJfZGljdCk7XG5cdFx0XHRcdGRlYnVnQ29uc29sZS5kZWJ1ZygnU3lub255bScsIHNpemVfc2VnbWVudCk7XG5cblx0XHRcdFx0X2luZm8ubGFzdCA9IE9iamVjdC5hc3NpZ24oe30sIF9pbmZvLmN1cnJlbnQpO1xuXG5cdFx0XHRcdF9pbmZvLmN1cnJlbnQgPSB7XG5cdFx0XHRcdFx0c2l6ZV9kYl9kaWN0LFxuXHRcdFx0XHRcdHNpemVfc2VnbWVudCxcblx0XHRcdFx0XHRzaXplX2RiX2RpY3RfZGlmZjogc2l6ZV9kYl9kaWN0IC0gKF9pbmZvLmxhc3Quc2l6ZV9kYl9kaWN0IHx8IDApLFxuXHRcdFx0XHRcdHNpemVfc2VnbWVudF9kaWZmOiBzaXplX3NlZ21lbnQgLSAoX2luZm8ubGFzdC5zaXplX3NlZ21lbnQgfHwgMCksXG5cblx0XHRcdFx0XHR2ZXJzaW9uLFxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdGRlYnVnQ29uc29sZS5kZWJ1ZyhfaW5mbyk7XG5cblx0XHRcdFx0aWYgKCFkaXNhYmxlQ2FjaGVcblx0XHRcdFx0XHQmJiAoX2RvX2luaXQgfHwgIWNhY2hlX2RiIHx8ICFjYWNoZV9kYi5ESUNUKVxuXHRcdFx0XHQpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhd2FpdCBDQUNIRURfQ0FDQUNIRS53cml0ZUpTT04oREJfS0VZLCB7XG5cblx0XHRcdFx0XHRcdC4uLl9pbmZvLFxuXG5cdFx0XHRcdFx0XHRESUNUOiBDQUNIRURfU0VHTUVOVC5ESUNULFxuXHRcdFx0XHRcdH0gYXMgSURhdGFDYWNoZSk7XG5cblx0XHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoYOe3qeWtmOWtl+WFuOaWvCAke0RCX0tFWX1gLCBDQUNIRURfQ0FDQUNIRS5jYWNoZVBhdGgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0ZnJlZUdDKCk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBDQUNIRURfU0VHTUVOVDtcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRGF0YUNhY2hlSW5mb1xue1xuXHRzaXplX2RiX2RpY3Q/OiBudW1iZXIsXG5cdHNpemVfc2VnbWVudD86IG51bWJlcixcblx0c2l6ZV9kYl9kaWN0X2RpZmY/OiBudW1iZXIsXG5cdHNpemVfc2VnbWVudF9kaWZmPzogbnVtYmVyLFxuXG5cdHZlcnNpb24/OiB7XG5cdFx0J25vdmVsLXNlZ21lbnQtY2xpJz86IHN0cmluZyxcblx0XHQnbm92ZWwtc2VnbWVudCc/OiBzdHJpbmcsXG5cdFx0J3NlZ21lbnQtZGljdCc/OiBzdHJpbmcsXG5cdH0sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURhdGFDYWNoZVxue1xuXHRsYXN0PzogSURhdGFDYWNoZUluZm8sXG5cdGN1cnJlbnQ/OiBJRGF0YUNhY2hlSW5mbyxcblx0RElDVD86IGFueSxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRDYWNoZUluZm8ob3B0aW9ucz86IElTZWdtZW50Q0xJT3B0aW9ucylcbntcblx0cmV0dXJuIGJsdWViaXJkXG5cdFx0LnJlc29sdmUoKVxuXHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uICgpXG5cdFx0e1xuXHRcdFx0YXdhaXQgZ2V0Q2FjYWNoZShvcHRpb25zKTtcblxuXHRcdFx0bGV0IGhhc19jYWNoZV9kYiA9IGF3YWl0IENBQ0hFRF9DQUNBQ0hFLmhhc0RhdGEoREJfS0VZX0lORk8pO1xuXG5cdFx0XHRsZXQgZGF0YTogSURhdGFDYWNoZTtcblxuXHRcdFx0aWYgKGhhc19jYWNoZV9kYilcblx0XHRcdHtcblx0XHRcdFx0ZGF0YSA9IGF3YWl0IENBQ0hFRF9DQUNBQ0hFXG5cdFx0XHRcdFx0LnJlYWRKU09OPElEYXRhQ2FjaGU+KERCX0tFWV9JTkZPKVxuXHRcdFx0XHRcdC50aGVuKGZ1bmN0aW9uIChyZXQpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmV0dXJuIHJldC5qc29uO1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdDtcblx0XHRcdH1cblxuXHRcdFx0ZGF0YSA9IGRhdGEgfHwge307XG5cblx0XHRcdGRhdGEubGFzdCA9IGRhdGEubGFzdCB8fCB7fTtcblx0XHRcdGRhdGEuY3VycmVudCA9IGRhdGEuY3VycmVudCB8fCB7fTtcblx0XHRcdGRhdGEubGFzdC52ZXJzaW9uID0gZGF0YS5sYXN0LnZlcnNpb24gfHwge307XG5cdFx0XHRkYXRhLmN1cnJlbnQudmVyc2lvbiA9IGRhdGEuY3VycmVudC52ZXJzaW9uIHx8IHt9O1xuXG5cdFx0XHRyZXR1cm4gZGF0YTtcblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRDYWNoZURiKG9wdGlvbnM/OiBJU2VnbWVudENMSU9wdGlvbnMpOiBibHVlYmlyZDxJRGF0YUNhY2hlPlxue1xuXHRvcHRpb25zID0gZml4T3B0aW9ucyhvcHRpb25zKTtcblx0bGV0IHsgZGlzYWJsZUNhY2hlIH0gPSBvcHRpb25zO1xuXG5cdGlmIChkaXNhYmxlQ2FjaGUpXG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdC5yZXNvbHZlKG51bGwpXG5cdFx0XHQ7XG5cdH1cblxuXHRyZXR1cm4gYmx1ZWJpcmRcblx0XHQucmVzb2x2ZSgpXG5cdFx0LnRoZW4oYXN5bmMgZnVuY3Rpb24gKClcblx0XHR7XG5cdFx0XHRhd2FpdCBnZXRDYWNhY2hlKG9wdGlvbnMpO1xuXG5cdFx0XHRsZXQgaGFzX2NhY2hlX2RiID0gYXdhaXQgQ0FDSEVEX0NBQ0FDSEUuaGFzRGF0YShEQl9LRVksIHtcblx0XHRcdFx0dHRsOiBvcHRpb25zLnR0bCA+IDAgPyBvcHRpb25zLnR0bCA6IERCX1RUTCxcblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoaGFzX2NhY2hlX2RiKVxuXHRcdFx0e1xuXHRcdFx0XHRkZWJ1Z0NvbnNvbGUuZGVidWcoYOeZvOePvue3qeWtmCAke0RCX0tFWX1gLCBoYXNfY2FjaGVfZGIucGF0aCk7XG5cblx0XHRcdFx0cmV0dXJuIENBQ0hFRF9DQUNBQ0hFXG5cdFx0XHRcdFx0LnJlYWRKU09OPElEYXRhQ2FjaGU+KERCX0tFWSlcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbiAocmV0KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJldHVybiByZXQuanNvbjtcblx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdDtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVDYWNoZShvcHRpb25zPzogSVNlZ21lbnRDTElPcHRpb25zKVxue1xuXHRyZXR1cm4gZ2V0Q2FjYWNoZShmaXhPcHRpb25zKG9wdGlvbnMpKVxuXHRcdC50YXAoYXN5bmMgZnVuY3Rpb24gKGNhY2hlKVxuXHRcdHtcblx0XHRcdGF3YWl0IGNhY2hlLmNsZWFyTWVtb2l6ZWQoKTtcblx0XHRcdGF3YWl0IGNhY2hlLnJlbW92ZUFsbCgpO1xuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzZXRDYWNoZSgpXG57XG5cdENBQ0hFRF9DQUNBQ0hFID0gdm9pZCAwXG59XG4iXX0=